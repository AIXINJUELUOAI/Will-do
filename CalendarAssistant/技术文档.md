# Will do 项目完整技术文档

## 项目概述

Will do 是一个基于 Android 的智能日程管理应用，使用 Jetpack Compose 构建，采用 MVVM 架构模式。项目经过重构，实现了更清晰的代码分层和更模块化的设计。

**当前版本**：v1.3.0 (versionCode: 3)
**开发语言**：Kotlin 2.0.21
**最低支持**：Android 8.0 (API 26)
**目标平台**：Android 16 (API 36)

**项目特色**：
- 智能日程识别（AI + OCR）
- 多厂商实况胶囊支持（Flyme/原生 Android）
- 完善的课程表管理系统
- 简约优雅的 Compose UI 设计
- 日历双向同步
- 智能推荐功能
- 自动归档过期日程
- 一键识屏快捷方式（配合三星 One Hand Operation+）

### 核心功能
- **课程表管理**：支持单双周、排除日期、影子课程（单次修改）
- **智能日程识别**：基于 AI 的 OCR 和自然语言处理
- **实况胶囊通知**：支持 Android 14+ 原生、Flyme 系统
- **全局提前提醒**：所有日程可提前 10/20/30 分钟显示胶囊和提醒
- **胶囊状态显示**：动态显示"还有 x 分钟开始"或"进行中"
- **取件码聚合显示**：多个取件码自动聚合为一个胶囊（可选）
- **系统闹钟集成**：自动创建系统闹钟
- **每日日程提醒**：早晚汇总通知
- **快速设置磁贴**：一键识别日程
- **一键识屏快捷方式**：配合三星 One Hand Operation+ 实现无感侧滑识别
- **响应式设计**：支持缩放、深色模式、侧边栏导航
- **取件码过期预警**：取件码即将过期时自动提醒，支持一键延长30分钟
- **多厂商适配**：Flyme 实况通知、原生 Live Activity
- **日历同步**：与系统日历双向同步，支持多日历管理
- **智能推荐**：基于历史数据推荐合适的日程安排
- **自动归档**：自动归档过期的日程事件

### 核心架构哲学

**架构模式：MVVM + Repository**
- 采用单例 Repository 模式管理数据
- ViewModel 负责业务逻辑和状态管理
- StateFlow 实现响应式数据流

**数据源设计：单一 JSON 本源**
- 不使用 SQLite/Room 数据库
- 数据量级 < 5000 条时，JSON 全量读写 I/O 耗时远小于数据库 ORM
- 天然支持备份导出，零 Migration 成本

**UI 渲染：全量 Jetpack Compose**
- 100% 声明式 UI，代码简洁易维护
- 原生支持动画和过渡效果
- 手势冲突处理更加灵活可控

**后台能力：系统级服务**
- 利用无障碍服务实现无感截图
- 利用前台服务实现实况胶囊
- 利用快速设置磁贴实现快速访问

---

## 目录结构

```
F:\Will do\
├── app/                                    # 主应用模块
│   ├── src/main/
│   │   ├── java/com/antgskds/calendarassistant/
│   │   │   ├── App.kt                     # Application 单例
│   │   │   ├── MainActivity.kt            # 主入口 Activity
│   │   │   ├── core/                      # 核心业务逻辑层
│   │   │   │   ├── ai/                    # AI 相关功能
│   │   │   │   │   ├── AiPrompts.kt       # AI 提示词模板
│   │   │   │   │   ├── ApiModelProvider.kt    # AI API 提供者
│   │   │   │   │   └── RecognitionProcessor.kt # 识别处理器
│   │   │   │   ├── calendar/              # 日历管理
│   │   │   │   │   ├── CalendarManager.kt         # 日历管理器
│   │   │   │   │   ├── CalendarSyncManager.kt    # 日历同步管理器
│   │   │   │   │   ├── CalendarEventMapper.kt    # 事件映射
│   │   │   │   │   ├── CalendarContentObserver.kt # 内容观察者
│   │   │   │   │   └── CalendarPermissionHelper.kt # 权限助手
│   │   │   │   ├── capsule/               # 胶囊状态管理
│   │   │   │   │   └── CapsuleStateManager.kt # 胶囊状态管理器
│   │   │   │   ├── course/                # 课程管理
│   │   │   │   │   └── CourseManager.kt   # 课程管理器
│   │   │   │   ├── importer/              # 课程导入
│   │   │   │   │   ├── ICourseImporter.kt         # 导入接口
│   │   │   │   │   └── WakeUpCourseImporter.kt   # 醒课表导入器
│   │   │   │   └── util/                  # 工具类
│   │   │   │       ├── DateCalculator.kt  # 日期计算工具
│   │   │   │       ├── EventDeduplicator.kt     # 事件去重工具
│   │   │   │       ├── FlymeUtils.kt      # Flyme 系统工具
│   │   │   │       └── LunarCalendarUtils.kt # 农历工具
│   │   │   ├── data/                      # 数据层
│   │   │   │   ├── model/                 # 数据模型
│   │   │   │   │   ├── CalendarEventData.kt # 日历事件数据
│   │   │   │   │   ├── Course.kt          # 课程模型
│   │   │   │   │   ├── EventFingerprint.kt    # 事件指纹
│   │   │   │   │   ├── ImportResult.kt    # 导入结果
│   │   │   │   │   ├── ModelPayload.kt    # 模型请求数据
│   │   │   │   │   ├── MyEvent.kt         # 用户事件模型
│   │   │   │   │   ├── MySettings.kt      # 设置模型
│   │   │   │   │   ├── SyncData.kt        # 同步数据模型
│   │   │   │   │   ├── TimeNode.kt        # 时间节点模型
│   │   │   │   │   ├── external/          # 外部数据模型
│   │   │   │   │   │   └── wakeup/        # 醒课表DTO
│   │   │   │   │   │       └── WakeUpDTOs.kt
│   │   │   │   │   └── serializers/       # 序列化器
│   │   │   │   │       ├── ColorSerializer.kt # 颜色序列化
│   │   │   │   │       └── LocalDateSerializer.kt # 日期序列化
│   │   │   │   ├── repository/            # 仓储层
│   │   │   │   │   └── AppRepository.kt   # 应用仓储（单例）
│   │   │   │   ├── source/                # 数据源
│   │   │   │   │   ├── ArchiveJsonDataSource.kt # 归档数据源
│   │   │   │   │   ├── CourseJsonDataSource.kt # 课程数据源
│   │   │   │   │   ├── EventJsonDataSource.kt  # 事件数据源
│   │   │   │   │   ├── SettingsDataSource.kt   # 设置数据源
│   │   │   │   │   └── SyncJsonDataSource.kt   # 同步数据源
│   │   │   │   └── state/                 # 状态定义
│   │   │   │       └── CapsuleUiState.kt  # 胶囊UI状态
│   │   │   ├── service/                   # 服务层
│   │   │   │   ├── accessibility/         # 无障碍服务
│   │   │   │   │   └── TextAccessibilityService.kt # 文本无障碍服务
│   │   │   │   ├── capsule/               # 胶囊服务
│   │   │   │   │   ├── CapsuleService.kt  # 胶囊服务（Dumb Service）
│   │   │   │   │   ├── CapsuleUiUtils.kt  # 胶囊 UI 工具
│   │   │   │   │   ├── NetworkSpeedMonitor.kt # 网速监控
│   │   │   │   │   └── provider/          # 胶囊提供者
│   │   │   │   │       ├── FlymeCapsuleProvider.kt # Flyme 胶囊
│   │   │   │   │       ├── ICapsuleProvider.kt     # 胶囊接口
│   │   │   │   │       └── NativeCapsuleProvider.kt # 原生胶囊
│   │   │   │   ├── notification/          # 通知服务
│   │   │   │   │   └── NotificationScheduler.kt # 通知调度器
│   │   │   │   ├── receiver/              # 广播接收器
│   │   │   │   │   ├── AlarmReceiver.kt   # 闹钟接收器
│   │   │   │   │   ├── BootReceiver.kt    # 开机启动接收器
│   │   │   │   │   ├── DailySummaryReceiver.kt # 每日摘要接收器
│   │   │   │   │   ├── EventActionReceiver.kt    # 事件操作接收器
│   │   │   │   │   └── PickupExpiryReceiver.kt  # 取件码过期预警接收器
│   │   │   │   ├── shortcut/              # 快捷方式
│   │   │   │   │   └── ShortcutHandleActivity.kt # 快捷方式中转 Activity
│   │   │   │   └── tile/                  # 快捷服务
│   │   │   │       └── CaptureTileService.kt # 截图快捷服务
│   │   │   ├── ui/                        # 用户界面
│   │   │   │   ├── analyzer/              # 智能分析
│   │   │   │   │   └── ScheduleRecommendationAnalyzer.kt # 日程推荐分析器
│   │   │   │   ├── components/            # 通用组件
│   │   │   │   │   ├── CommonSettings.kt  # 通用设置组件
│   │   │   │   │   ├── SettingsSidebar.kt # 设置侧边栏
│   │   │   │   │   └── UniversalToast.kt  # 通用 Toast 组件
│   │   │   │   ├── dialogs/               # 对话框组件
│   │   │   │   │   ├── AddEventDialog.kt  # 添加事件对话框
│   │   │   │   │   ├── AiInputDialog.kt   # AI 输入对话框
│   │   │   │   │   ├── CourseManagementDialog.kt # 课程管理对话框
│   │   │   │   │   └── DialogContainer.kt # 对话框容器
│   │   │   │   ├── event_display/         # 事件显示组件
│   │   │   │   │   ├── EventCardFactory.kt # 事件卡片工厂
│   │   │   │   │   └── SwipeableEventItem.kt # 可滑动事件项
│   │   │   │   ├── layout/                # 自定义布局
│   │   │   │   │   └── PushSlideLayout.kt # 侧滑抽屉布局
│   │   │   │   ├── page_display/          # 页面显示
│   │   │   │   │   ├── AllEventsPage.kt   # 所有事件页面
│   │   │   │   │   ├── HomePage.kt        # 主页（今日视图）
│   │   │   │   │   ├── HomeScreen.kt      # 主屏容器
│   │   │   │   │   ├── SchedulePage.kt    # 日程页面
│   │   │   │   │   ├── SettingsDetailScreen.kt # 设置详情容器
│   │   │   │   │   └── settings/          # 设置子页面
│   │   │   │   │       ├── AboutPage.kt           # 关于页面
│   │   │   │   │       ├── AiSettingsPage.kt      # AI 模型设置
│   │   │   │   │       ├── ArchivesPage.kt        # 归档页面
│   │   │   │   │       ├── BackupSettingsPage.kt  # 数据备份设置
│   │   │   │   │       ├── CourseManagerScreen.kt # 课程管理页面
│   │   │   │   │       ├── LaboratoryPage.kt      # 实验室页面
│   │   │   │   │       ├── PreferenceSettingsPage.kt # 偏好设置
│   │   │   │   │       ├── ScheduleSettingsPage.kt  # 课表设置
│   │   │   │   │       └── TimeTableEditorScreen.kt # 作息时间编辑
│   │   │   │   ├── theme/                 # 主题配置
│   │   │   │   │   ├── Color.kt           # 颜色定义
│   │   │   │   │   ├── Theme.kt           # 主题定义
│   │   │   │   │   └── Type.kt            # 字体类型定义
│   │   │   │   └── viewmodel/             # ViewModel
│   │   │   │       ├── MainViewModel.kt   # 主 ViewModel
│   │   │   │       └── SettingsViewModel.kt # 设置 ViewModel
│   │   │   ├── res/                       # 资源文件
│   │   │   │   ├── layout/                # 布局资源
│   │   │   │   │   └── notification_live_flyme.xml # Flyme实况通知布局
│   │   │   │   ├── drawable/              # 图形资源
│   │   │   │   ├── values/                # 值资源
│   │   │   │   ├── mipmap-*/              # 应用图标
│   │   │   │   └── xml/                   # XML 配置
│   │   │   └── AndroidManifest.xml        # 应用清单
│   │   └── build.gradle.kts               # 应用级构建配置
├── gradle/                                # Gradle 包装器
├── build.gradle.kts                       # 项目级构建配置
├── settings.gradle.kts                    # 项目设置
└── gradle.properties                      # Gradle 属性
```

---

# 第一部分：用户操作手册

## 1. 基础导航

### 1.1 主界面布局

应用采用底部导航栏设计：
- **主页**：显示当前选中日期的日程列表和课程卡片
- **全部日程**：显示所有日程的列表视图，支持搜索和筛选
- **设置**：AI 模型设置、课程表设置、偏好设置、数据备份

### 1.2 设置页面

点击底部导航栏的设置图标，可打开设置页面，包含：
- AI 模型设置
- 课程表设置
- 偏好设置
- 数据备份（导入/导出）
- 归档管理

---

## 2. 手势操作详解

### 2.1 下拉查看课表

**操作方式**：在主页视图中，向下拖动屏幕

**效果**：
- 课程表视图会从底部逐渐浮现
- 当前日程列表会同时向上滑动并淡出
- 课程表会呈现缩放放大的动画效果

**动画参数**：
```kotlin
最大偏移量: 600dp
透明度变化: 0% → 100%
缩放变化: 90% → 100%
```

**实现位置**：`ui/page_display/HomePage.kt:70-103`

### 2.2 课表视图的撤销机制

**触发条件**：下拉课表后，不松手反悔了

**撤销阈值详解**：

| 滑动速度 | 效果 | 阈值 |
|---------|------|------|
| 快速下滑 | 完全展开课表 | 速度 > 1000 |
| 快速上滑 | 完全收起课表 | 速度 < -1000 |
| 普通滑动 | 超过 1/3 展开，否则收起 | 位置 > 200dp (600dp/3) |

### 2.3 日期切换（左右滑动）

**操作方式**：在主页视图的日期卡片上左右滑动

**阈值**：
- 左滑 > 50px → 切换到下一天
- 右滑 > 50px → 切换到上一天

### 2.4 课程表周次切换

在课表视图中：
- 点击左上角箭头或周次文字 → 切换周次
- 点击当前周次 → 快速跳转到本周

### 2.5 事件项操作菜单

**操作方式**：在日程项上向左滑动

**阈值**：
- 超过菜单宽度的一半 (80dp) → 展开操作菜单
- 否则 → 收回

**操作菜单包含三个按钮**：
1. **编辑**（绿色）：修改日程内容
2. **星标**（黄色）：标记为重要
3. **删除**（红色）：删除日程

### 2.6 物理返回键

**功能**：当课表视图已展开时，按返回键会收起课表视图

---

## 3. 课程表功能

### 3.1 查看课程表
1. 在主页视图中向下拉动屏幕
2. 课程表会从底部浮现
3. 可查看整周的课程安排

### 3.2 课程表显示逻辑

**周次计算**：
```kotlin
// 根据学期开始日期计算当前周
val realCurrentWeek = (daysBetween(semesterStart, today) / 7) + 1
```

**课程筛选条件**：
1. 周次范围匹配：`currentWeek in course.startWeek..course.endWeek`
2. 单双周匹配：
   - 0 = 每周
   - 1 = 单周
   - 2 = 双周
3. 星期几匹配
4. 排除日期：课程在该日期被排除时不显示

**实现位置**：`ui/page_display/SchedulePage.kt:85-102`

### 3.3 周次切换
- 点击左右箭头切换周次
- 点击周次标题快速返回本周
- 周次标题显示当前月份

### 3.4 课程卡片显示
- 显示课程名称（最多3行，超出显示省略号）
- 显示地点信息（如 @A101）
- 使用课程设置的颜色作为背景

---

## 4. 课程管理

### 4.1 添加课程

**入口**：设置 → 课程表设置 → 管理课程 → 添加课程

**可设置字段**：
- 课程名称（必填）
- 上课地点
- 授课教师
- **上课时间**：星期几、第几节到第几节
- **周次范围**：第几周到第几周
- **课程频率**：每周/单周/双周
- **颜色标签**：新增课程时自动从 EventColors 随机分配（无需手动选择）

**实现位置**：`ui/dialogs/CourseManagementDialog.kt`

### 4.2 编辑课程
点击课程列表中的课程，进入编辑界面

### 4.3 删除课程
点击课程列表项右侧的删除图标

**删除逻辑**：
```
删除主课程 → 同时删除所有关联的影子课程（单次修改的课程）
```

**实现位置**：`data/repository/AppRepository.kt:116-130`

### 4.4 单次课程编辑（影子课程机制）

**场景**：某次课临时调整时间/地点/取消

**操作方式**：
1. 在主页视图中点击课程卡片
2. 选择"编辑单次课程"
3. 修改名称、地点、节次、日期
4. 保存

**技术实现**：
1. 原课程被加入该日期的排除列表
2. 创建一个新的影子课程（`isTemp = true`）
3. 影子课程关联父课程（`parentCourseId`）

**删除单次课程**：
- 如果是影子课程 → 直接删除
- 如果是主课程 → 加入排除列表

### 4.5 导入课程

**导入**：
- 设置 → 课程表设置 → 导入课程表
- 支持导入醒课表数据格式

---

## 5. 作息时间设置

### 5.1 打开作息时间编辑器

**入口**：设置 → 课程表设置 → 编辑作息时间

### 5.2 可调整项

1. **总节数**：4-16节可选
2. **上课时长**：默认45分钟
3. **开始时间**：
   - 上午课程开始时间（默认8:00）
   - 下午课程开始时间（默认14:00）
   - 晚上课程开始时间（默认19:00）
4. **课间休息**：每节课之间的休息时间（默认10分钟）

### 5.3 时间计算逻辑

```kotlin
// 第1节：上午开始时间
if (i == 1) startTime = morningStart

// 第5节：下午开始时间
else if (i == 5) startTime = afternoonStart

// 第9节：晚上开始时间
else if (i == 9) startTime = nightStart

// 其他节次：前一节结束 + 课间休息
else {
    prevEnd + breakMinutes
}
```

---

## 6. 日程管理

### 6.1 添加日程

**方式一：手动添加**
1. 点击右下角悬浮按钮（+）
2. 填写以下信息：
   - 标题（必填）
   - 类型：日程 / 取件取餐
   - 开始日期和时间
   - 结束日期和时间
   - 地点
   - 备注
   - 提醒时间
3. 点击确定

**提醒选项**：
```
开始时、5分钟前、10分钟前、15分钟前、30分钟前、
1小时前、2小时前、6小时前、1天前、2天前
```

**方式二：AI 智能创建**
1. 点击右上角小悬浮按钮（✨）
2. 输入自然语言，例如：
   - "明天下午3点在会议室开会"
   - "下周五晚上8点去取快递 5566"
3. 点击"解析生成"

### 6.2 编辑日程

1. 在日程列表中左滑展开操作菜单
2. 点击编辑按钮（绿色）
3. 修改内容后保存

### 6.3 删除日程

1. 在日程列表中左滑展开操作菜单
2. 点击删除按钮（红色）

### 6.4 标记重要

1. 在日程列表中左滑展开操作菜单
2. 点击星标按钮（黄色）
3. 重要日程会显示星标图标

### 6.5 排除单次课程

对于课程类型的日程，删除操作会：
1. 将该日期加入课程的排除列表
2. 该课程在该日期不再显示

---

## 7. 导入/导出数据

### 7.1 导出所有日程

1. 打开设置页面
2. 点击"导出所有日程"
3. 文件保存到下载目录
4. 文件名格式：`CalendarBackup_时间戳.json`

### 7.2 导入日程

1. 打开设置页面
2. 点击"导入日程"
3. 选择 JSON 文件
4. 系统自动去重，只导入新日程

---

## 8. 设置说明

### 8.1 AI 模型设置

**可配置项**：
- 服务提供商（快速选择或自定义）
- 模型名称（根据提供商自动提供下拉选项）
- API 地址（提供商自动填充，自定义可手动输入）
- API Key

**支持的服务商**：
- **DeepSeek**: deepseek-chat, deepseek-coder, deepseek-reasoner
- **OpenAI**: gpt-4o-mini, gpt-4o, gpt-3.5-turbo
- **Gemini**: gemini-1.5-flash, gemini-1.5-pro
- **自定义**: 支持任意兼容OpenAI格式的API地址

### 8.2 课程表设置

1. **学期开始日期**：用于计算当前周次
2. **总周数**：默认20周
3. **管理课程**：进入课程管理界面
4. **编辑作息时间**：调整上课时间

### 8.3 偏好设置

**显示板块**：
- 界面大小：调整字体大小（小/中/大）
- 显示明日日程：在今日日程列表底部预览明日安排

**通知板块**：
- 每日日程提醒：早06:00和晚22:00推送汇总
- 实况胶囊通知 (Beta)：日程开始前显示灵动岛/胶囊
  - 取件码聚合 (Beta)：当有多个取件码时合并显示为一个胶囊
- 日程提前提醒：可设置提前 10/20/30 分钟

**日程板块**：
- 日历同步：将课程和日程同步到系统日历
- 自动归档：日程过期后立即自动归档
- 智能推荐：基于历史数据在创建日程时显示推荐

### 8.4 实验室功能

- 取件码聚合开关
- 网速胶囊开关
- 智能推荐开关
- 自动归档开关

---

## 9. 智能识别功能

### 9.1 截图识别（需无障碍服务）

**方式一：快捷设置磁贴**
1. 开启无障碍服务
2. 下拉快捷设置，点击"识别日程"磁贴
3. 等待延迟后自动截图
4. AI 自动识别日程信息

**方式二：一键识屏快捷方式**
1. 开启无障碍服务
2. 长按桌面添加快捷方式，选择"一键识屏"
3. 配合三星 One Hand Operation+，设置侧滑手势触发该快捷方式
4. 侧滑触发后透明 Activity 立即启动并发送截图指令，无感识别

**技术实现**：
- 使用动态快捷方式（Dynamic Shortcuts）
- 透明中转 Activity（ShortcutHandleActivity）
- 独立任务栈（taskAffinity=""），不影响当前应用
- 延迟 400ms 确保透明 Activity 完全销毁后截图

### 9.2 取件码模式

识别取件码/取餐码后，会：
1. 创建临时事件类型
2. 将取件码显示在备注中
3. 可快速查看号码

---

## 10. 日历同步

### 10.1 同步功能

支持与系统日历双向同步：
- 将本地日程同步到系统日历
- 从系统日历导入日程
- 支持多日历账户
- 自动去重处理

### 10.2 同步设置

- 选择要同步的日历账户
- 设置同步方向（双向/仅上传/仅下载）
- 排除特定类型事件（如取件码）

---

## 11. 实况胶囊通知

### 11.1 功能说明

在日程开始前，会在通知栏显示实况胶囊，包含：
- 日程标题
- 剩余时间倒计时
- 快捷操作按钮

### 11.2 系统支持

- Android 14+ 原生实况胶囊
- Flyme 系统（魅族）

---

# 第二部分：技术实现详解

## 1. 架构设计

### 1.1 MVVM + 胶囊状态管理架构

项目采用标准的 MVVM（Model-View-ViewModel）架构，并引入了胶囊状态管理器实现主动唤醒模式：

```
┌─────────────────────────────────────────────────────────────────┐
│                        UI Layer                                 │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐         │
│  │  HomePage    │  │ SettingsPage │  │  Dialogs     │         │
│  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘         │
│         │                  │                  │                 │
│         └──────────────────┼──────────────────┘                 │
│                            │                                    │
│  ┌─────────────────────────▼─────────────────────────┐         │
│  │              MainViewModel / SettingsViewModel     │         │
│  └─────────────────────────┬─────────────────────────┘         │
└────────────────────────────┼────────────────────────────────────┘
                             │
┌────────────────────────────▼────────────────────────────────────┐
│                    Repository Layer                              │
│  ┌───────────────────────────────────────────────────────────┐ │
│  │              AppRepository (Singleton)                     │ │
│  │  ┌─────────┐ ┌─────────┐ ┌─────────────────────────────┐ │ │
│  │  │ Events  │ │ Courses │ │  CapsuleStateManager         │ │ │
│  │  └────┬────┘ └────┬────┘ └──────────┬──────────────────┘ │ │
│  └───────┼───────────┼─────────────────┼─────────────────────┘ │
└──────────┼───────────┼─────────────────┼────────────────────────┘
           │           │                 │
┌──────────▼──────┐ ┌──▼──────────────┐ ┌▼────────────────────────┐
│ EventJsonData   │ │ CourseJsonData  │ │ CapsuleUiState (StateFlow)│
│ Source          │ │ Source          │ │ (None / Active)          │
└─────────────────┘ └─────────────────┘ └──────────────────────────┘
                                                      │
                                          ┌───────────▼─────────────┐
                                          │  CapsuleService         │
                                          │  (Dumb Service)         │
                                          │  - 白名单机制           │
                                          │  - 主动唤醒             │
                                          └─────────────────────────┘
```

**关键特性**：
1. **单向数据流**：UI → 观察 ViewModel → 调用 Repository → 更新数据 → 回流到 UI
2. **状态管理**：使用 `StateFlow` 管理响应式状态
3. **单例 Repository**：`AppRepository` 采用单例模式，确保数据一致性
4. **协程支持**：所有数据操作使用 Kotlin 协程进行异步处理
5. **胶囊状态管理**：`CapsuleStateManager` 统一计算胶囊状态，主动唤醒 `CapsuleService`

### 1.2 数据模型

#### 1.2.1 MyEvent（日程事件模型）

**文件位置**: `data/model/MyEvent.kt`

```kotlin
@Serializable
data class MyEvent(
    val id: String = UUID.randomUUID().toString(),
    val title: String,
    @Serializable(with = LocalDateSerializer::class)
    val startDate: LocalDate,
    @Serializable(with = LocalDateSerializer::class)
    val endDate: LocalDate,
    val startTime: String,             // HH:mm
    val endTime: String,               // HH:mm
    val location: String,
    val description: String,
    @Serializable(with = ColorSerializer::class)
    val color: Color,
    val isImportant: Boolean = false,
    val sourceImagePath: String? = null,
    val reminders: List<Int> = emptyList(),
    val eventType: String = "event",   // "event" | "course" | "temp"
    val archivedAt: Long? = null,      // 归档时间戳
    val calendarId: String? = null,    // 系统日历ID
    val calendarEventId: String? = null // 系统日历事件ID
)
```

**`eventType` 字段说明**：

| 值 | 含义 | 说明 |
|----|------|------|
| `"event"` | 普通日程 | 用户手动添加或 AI 解析的日程 |
| `"temp"` | 临时取件/取餐 | AI 识别的取件码，存储在 description |
| `"course"` | 虚拟课程日程 | 仅在运行时生成，虚拟 ID 格式：`course_{CourseID}_{Date}` |

#### 1.2.2 Course（课程模型）

**文件位置**: `data/model/Course.kt`

```kotlin
@Serializable
data class Course(
    val id: String,
    val name: String,
    val location: String = "",
    val teacher: String = "",
    @Serializable(with = ColorSerializer::class)
    val color: Color,
    val dayOfWeek: Int,                // 1=Mon, 7=Sun
    val startNode: Int,
    val endNode: Int,
    val startWeek: Int,
    val endWeek: Int,
    val weekType: Int = 0,             // 0=All, 1=Odd, 2=Even
    val excludedDates: List<String> = emptyList(),
    val isTemp: Boolean = false,       // 是否为影子课程
    val parentCourseId: String? = null // 父课程ID（影子课程用）
)
```

#### 1.2.3 MySettings（设置模型）

**文件位置**: `data/model/MySettings.kt`

```kotlin
@Serializable
data class MySettings(
    // AI 模型配置
    val modelKey: String = "",
    val modelName: String = "gpt-3.5-turbo",
    val modelUrl: String = "",
    val modelProvider: String = "",

    // 功能开关
    val showTomorrowEvents: Boolean = false,
    val isDailySummaryEnabled: Boolean = false,
    val isAdvanceReminderEnabled: Boolean = false,
    val advanceReminderMinutes: Int = 20,

    // 识别设置
    val tempEventsUseRecognitionTime: Boolean = true,
    val screenshotDelayMs: Long = 500L,
    val isLiveCapsuleEnabled: Boolean = false,

    // 取件码聚合
    val isPickupAggregationEnabled: Boolean = false,

    // 归档配置
    val autoArchiveEnabled: Boolean = false,
    val archiveDaysThreshold: Int = 0,

    // 课表设置
    val semesterStartDate: String = "",
    val totalWeeks: Int = 20,
    val timeTableJson: String = "",

    // UI 设置
    val isDarkMode: Boolean = false,
    val uiSize: Int = 2,

    // 实验室功能
    val isNetworkSpeedCapsuleEnabled: Boolean = false,
    val enableSmartRecommendation: Boolean = true
)
```

#### 1.2.4 SyncData（同步数据模型）

**文件位置**: `data/model/SyncData.kt`

```kotlin
@Serializable
data class SyncData(
    val lastSyncTime: Long = 0,
    val calendarMappings: Map<String, String> = emptyMap(),  // 本地ID -> 系统日历ID
    val enabledCalendars: List<String> = emptyList(),         // 启用的日历账户
    val syncDirection: SyncDirection = SyncDirection.BOTH
)

enum class SyncDirection {
    BOTH,       // 双向同步
    UPLOAD,     // 仅上传
    DOWNLOAD    // 仅下载
}
```

### 1.3 胶囊状态管理器（CapsuleStateManager）

**文件位置**: `core/capsule/CapsuleStateManager.kt`

**职责**：
1. 统一计算胶囊状态（合并日程、课程、取件码）
2. 监听时间变化（每分钟）实现过期检测
3. 主动唤醒：当计算出 Active 状态时，启动 `CapsuleService`

**核心设计**：

```kotlin
class CapsuleStateManager(
    private val repository: AppRepository,
    private val appScope: CoroutineScope,
    private val context: Context
) {
    // 胶囊UI状态 - StateFlow
    val uiState: StateFlow<CapsuleUiState> = createCapsuleStateFlow()

    init {
        // 主动唤醒机制：监听 uiState，当变为 Active 时启动 Service
        startServiceWakeup()
    }

    // 合并：events + courses + settings + ticker(每分钟)
    private fun createCapsuleStateFlow(): StateFlow<CapsuleUiState> {
        val tickerFlow = flow {
            emit(System.currentTimeMillis()) // 立即发射第一个值
            while (true) {
                delay(60_000) // 每分钟
                emit(System.currentTimeMillis())
            }
        }

        return combine(
            repository.events,
            repository.courses,
            repository.settings,
            tickerFlow
        ) { events, courses, settings, _ ->
            computeCapsuleState(events, courses, settings)
        }.stateIn(...)
    }
}
```

### 1.4 Repository 模式详解

**文件位置**：`data/repository/AppRepository.kt`

```kotlin
class AppRepository private constructor(private val context: Context) {
    // 数据源
    private val eventSource = EventJsonDataSource(context)
    private val courseSource = CourseJsonDataSource(context)
    private val settingsSource = SettingsDataSource(context)
    private val archiveSource = ArchiveJsonDataSource(context)
    private val syncSource = SyncJsonDataSource(context)

    // StateFlows - 响应式数据流
    private val _events = MutableStateFlow<List<MyEvent>>(emptyList())
    val events: StateFlow<List<MyEvent>> = _events.asStateFlow()

    private val _courses = MutableStateFlow<List<Course>>(emptyList())
    val courses: StateFlow<List<Course>> = _courses.asStateFlow()

    private val _settings = MutableStateFlow(MySettings())
    val settings: StateFlow<MySettings> = _settings.asStateFlow()

    // 并发控制
    private val eventMutex = Mutex()
    private val courseMutex = Mutex()

    companion object {
        @Volatile
        private var INSTANCE: AppRepository? = null

        fun getInstance(context: Context): AppRepository {
            return INSTANCE ?: synchronized(this) {
                INSTANCE ?: AppRepository(context.applicationContext).also { INSTANCE = it }
            }
        }
    }
}
```

---

## 2. 核心功能模块

### 2.1 AI 智能识别

**文件位置**: `core/ai/RecognitionProcessor.kt`

**流程**：
```
用户点击磁贴
    ↓
TextAccessibilityService.startAnalysis()
    ↓ (延迟)
takeScreenshotAndAnalyze()
    ↓
RecognitionProcessor.analyzeImage(bitmap)
    ↓
ML Kit OCR 识别中文文字
    ↓
ApiModelProvider.generate() 发送 AI 请求
    ↓
AI 解析返回 CalendarEventData
    ↓
saveEventsLocally()
    ├─ 去重检查
    ├─ 创建 MyEvent
    └─ 调度提醒
    ↓
postLiveUpdateSafely()
    ↓
显示实况胶囊通知
```

### 2.2 日历同步管理

**文件位置**: `core/calendar/CalendarSyncManager.kt`

**功能**：
- 与系统日历双向同步
- 支持多日历账户
- 自动去重处理
- 冲突解决策略

### 2.3 智能推荐

**文件位置**: `ui/analyzer/ScheduleRecommendationAnalyzer.kt`

**功能**：
- 基于历史数据推荐合适的日程安排
- 分析空闲时间段
- 缓存机制提高性能

### 2.4 自动归档

**文件位置**: `data/source/ArchiveJsonDataSource.kt`

**功能**：
- 自动归档过期的日程事件
- 可配置归档阈值天数
- 支持查看和管理归档事件

---

## 3. UI 组件架构

### 3.1 主题系统

**文件位置**：`ui/theme/Color.kt`

```kotlin
// 默认颜色
val Purple80 = Color(0xFFD0BCFF)
val PurpleGrey80 = Color(0xFFCCC2DC)
val Pink80 = Color(0xFFEFB8C8)

// 事件颜色（循环使用）
val EventColors = listOf(
    Color(0xFF91A3B0), Color(0xFFB4C3A1), Color(0xFFD1B29E),
    Color(0xFF968D8D), Color(0xFFBCCAD6), Color(0xFFCFD1D3),
    Color(0xFFA2B5BB), Color(0xFFE2C4C4)
)
```

### 3.2 主要 Compose 组件

| 组件 | 文件位置 | 功能 |
|------|----------|------|
| `HomePage` | `ui/page_display/HomePage.kt` | 主页 |
| `AllEventsPage` | `ui/page_display/AllEventsPage.kt` | 全部日程列表 |
| `ScheduleView` | `ui/page_display/SchedulePage.kt` | 课程表视图 |
| `ArchivesPage` | `ui/page_display/settings/ArchivesPage.kt` | 归档页面 |
| `DialogContainer` | `ui/dialogs/DialogContainer.kt` | 对话框容器 |
| `SwipeableEventItem` | `ui/event_display/SwipeableEventItem.kt` | 可滑动事件项 |

### 3.3 新增组件

#### 3.3.1 UniversalToast（通用 Toast 组件）

**文件位置**：`ui/components/UniversalToast.kt`

**Toast 类型**：
```kotlin
enum class ToastType {
    SUCCESS,   // 成功（绿色图标）
    ERROR,     // 错误（红色图标）
    INFO       // 信息（蓝色图标）
}
```

#### 3.3.2 SettingsSidebar（设置侧边栏）

**文件位置**：`ui/components/SettingsSidebar.kt`

**导航目标枚举**：
```kotlin
enum class SettingsDestination {
    CourseManage,      // 课表管理
    TimeTableManage,   // 作息表管理
    SemesterConfig,    // 学期配置
    AI,                // 模型配置
    Preference,        // 偏好设置
    Backup,            // 数据备份
    ThemeToggle,       // 深色/浅色模式切换
    About              // 关于软件
}
```

#### 3.3.3 PushSlideLayout（侧滑抽屉布局）

**文件位置**：`ui/layout/PushSlideLayout.kt`

**核心特性**：
- 侧边栏宽度为屏幕宽度的 50%
- 支持手势拖动开关
- 遮罩层点击关闭
- 动画时长 300ms

---

## 4. 通知渠道与常量速查表

### 4.1 通知渠道配置

| 渠道 ID | 名称 | 重要性 | 用途 |
|---------|------|--------|------|
| `calendar_assistant_popup_channel_v2` | 普通通知 | HIGH | 日程提醒通知 |
| `calendar_assistant_live_channel_v3` | 实况胶囊 | HIGH | 实况胶囊（无声高优） |

### 4.2 UI 尺寸常量

| 常量 | 值 | 说明 |
|------|------|------|
| `HeaderHeight` | 50.dp | 课表表头高度 |
| `SidebarWidth` | 35.dp | 节次栏宽度 |
| `NodeHeight` | 64.dp | 单节课程高度 |
| 下拉展开阈值 | 200.dp (Drag) 或 1000f (Velocity) | 1/3 屏幕或快速甩动 |
| 侧滑菜单宽度 | 160.dp | 操作菜单宽度 |
| 截图默认延迟 | 500ms | 可在设置调整 |

### 4.3 时间常量

| 常量 | 值 | 说明 |
|------|------|------|
| 早报时间 | 06:00 | 每日汇总通知 |
| 晚报时间 | 22:00 | 每日汇总通知 |

---

## 5. 权限清单（完整版）

### 5.1 Android 权限声明

| 权限 | 用途 | 必要性 | 说明 |
|------|------|--------|------|
| `INTERNET` | 网络请求 | 必需 | AI API 调用需要 |
| `POST_NOTIFICATIONS` | 发送通知 | 必需 | Android 13+ 需要用户授权 |
| `SCHEDULE_EXACT_ALARM` | 调度精确闹钟 | 必需 | Android 12+ 需要 |
| `USE_EXACT_ALARM` | 使用精确闹钟 | 必需 | Android 14+ 需要 |
| `FOREGROUND_SERVICE` | 前台服务 | 必需 | 实况胶囊需要 |
| `FOREGROUND_SERVICE_SPECIAL_USE` | 特殊用途前台服务 | 必需 | 实况胶囊服务类型 |
| `com.android.alarm.permission.SET_ALARM` | 设置系统闹钟 | 必需 | 调用系统闹钟应用 |
| `READ_CALENDAR` | 读取日历 | 可选 | 日历同步功能 |
| `WRITE_CALENDAR` | 写入日历 | 可选 | 日历同步功能 |

---

## 6. 实况通知实现详解

### 6.1 胶囊架构概览

```
┌─────────────────────────────────────────────────────────────┐
│                   CapsuleStateManager                       │
│                   （主动计算 + 主动唤醒）                     │
│  ┌─────────────────────────────────────────────────────┐    │
│  │  computeCapsuleState()                              │    │
│  │  - 合并 events + courses (虚拟课程)                  │    │
│  │  - 过滤活跃事件（考虑全局提前提醒）                   │    │
│  │  - 取件码聚合判断                                    │    │
│  │  - 生成 CapsuleUiState (None/Active)                │    │
│  └─────────────────────────────────────────────────────┘    │
│                            │                                 │
│                            ▼                                 │
│  ┌─────────────────────────────────────────────────────┐    │
│  │  uiState.collect { state ->                         │    │
│  │    if (state is Active) 启动 CapsuleService         │    │
│  │    if (state is None) Service 自动停止              │    │
│  │  }                                                  │    │
│  └─────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│                     CapsuleService                           │
│                     （Dumb Service）                          │
│  ┌─────────────────────────────────────────────────────┐    │
│  │  职责：                                               │    │
│  │  1. 监听 uiState                                     │    │
│  │  2. 显示/隐藏胶囊通知                                │    │
│  │  3. 白名单机制：只保留合法通知                        │    │
│  └─────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────┘
```

### 6.2 全局提前提醒功能

**设置选项**：
```kotlin
val isAdvanceReminderEnabled: Boolean = false  // 全局提前提醒总开关
val advanceReminderMinutes: Int = 20           // 提前分钟数（10/20/30）
```

### 6.3 取件码聚合功能

**设置选项**：
```kotlin
val isPickupAggregationEnabled: Boolean = false  // 取件码聚合开关
```

---

## 7. 第三方依赖

| 库名 | 用途 | 版本 |
|------|------|------|
| Jetpack Compose | UI 框架 | 2024.09.00 BOM |
| Material3 | UI 组件 | 1.5.4 |
| Ktor Client | HTTP 客户端 | 2.3.7 |
| ML Kit Text Recognition | 文字识别 (OCR) | 16.0.1 |
| Kotlinx Serialization | JSON 序列化 | 1.6.3 |
| Kotlinx Coroutines | 协程支持 | 1.7.3 |
| Navigation Compose | 页面导航 | 2.8.0 |
| Lifecycle ViewModel | 状态管理 | 2.8.5 |
| Core KTX | Android 核心扩展 | 1.17.0 |
| Desugar JDK Libs | Java 8+ API 兼容 | 2.0.4 |

---

## 8. 版本要求

| 项目 | 版本 |
|------|------|
| 应用版本 | 1.3.0 (versionCode: 4) |
| 最低 SDK | 26 (Android 8.0) |
| 目标 SDK | 36 (Android 16) |
| 编译 SDK | 36 |
| 截图功能 | Android 11+ (SDK 30+) |
| 实况胶囊 | Android 14+ 或 Flyme |
| Kotlin 版本 | 2.0.21 |
| Compose BOM | 2024.09.00 |

---

## 9. 颜色常量

```kotlin
val EventColors = listOf(
    Color(0xFF91A3B0),  // 蓝灰
    Color(0xFFB4C3A1),  // 绿灰
    Color(0xFFD1B29E),  // 粉灰
    Color(0xFF968D8D),  // 棕灰
    Color(0xFFBCCAD6),  // 浅蓝灰
    Color(0xFFCFD1D3),  // 浅灰
    Color(0xFFA2B5BB),  // 青灰
    Color(0xFFE2C4C4)   // 浅粉灰
)
```

---

## 10. 数据存储位置

| 数据类型 | 存储位置 | 格式 |
|---------|----------|------|
| 日程事件 | `filesDir/events.json` | JSON |
| 课程数据 | `filesDir/courses.json` | JSON |
| 归档事件 | `filesDir/archives.json` | JSON |
| 同步数据 | `filesDir/sync.json` | JSON |
| 应用设置 | SharedPreferences | Key-Value |
| 导出备份 | `Downloads/CalendarBackup_*.json` | JSON |

---

# 附录：版本更新记录

### v1.4.0（当前版本）

**新增功能**：
- 一键识屏快捷方式：配合三星 One Hand Operation+ 实现无感侧滑识别
- 动态快捷方式（Dynamic Shortcuts）：透明中转 Activity 实现不退出当前应用的触发方式
- 新增快捷方式图标：ic_qs_quick_recognition（黑色扫描框图标）

**架构优化**：
- 新增 `ShortcutHandleActivity`：透明中转 Activity，独立任务栈
- 新增 `fromShortcut` 参数：区分快捷方式触发的截图识别

**UI/UX 改进**：
- 偏好设置页面重构：智能推荐从显示板块移至日程板块
- 磁贴图标更新：使用 ic_qs_recognition 扫描框图标

---

### v1.3.0

**新增功能**：
- 日历双向同步：支持与系统日历双向同步
- 智能推荐：基于历史数据推荐合适的日程安排
- 自动归档：自动归档过期的日程事件
- 归档管理：查看和管理归档的事件
- 课程导入：支持导入醒课表数据格式

**架构优化**：
- 新增 `CalendarManager`：统一管理系统日历操作
- 新增 `CalendarSyncManager`：处理日历同步逻辑
- 新增 `SyncData` 模型：存储同步状态和映射关系
- 新增 `ArchiveJsonDataSource`：归档数据源管理

**UI/UX 改进**：
- 新增归档页面：查看已归档的事件
- 优化同步设置界面
- 改进推荐卡片显示

**MySettings 新增字段**：
- `autoArchiveEnabled`: Boolean = false  // 自动归档开关
- `archiveDaysThreshold`: Int = 0        // 归档阈值天数
- `enableSmartRecommendation`: Boolean = true // 智能推荐开关

---

### v1.2.0

**架构重构**：
- 新增 `CapsuleStateManager`（胶囊状态管理器）：主动唤醒模式
- `CapsuleService` 重构为 Dumb Service：白名单机制，计算与显示分离
- 新增 `CapsuleUiState`：胶囊UI状态定义（None/Active）

**新增功能**：
- 全局提前提醒：所有日程可提前 10/20/30 分钟显示胶囊和提醒
- 胶囊状态显示：动态显示"还有 x 分钟开始"或"进行中"
- 取件码聚合显示：多个取件码自动聚合为一个胶囊（可选）
- 胶囊准点刷新：自动刷新胶囊文案从"还有x分钟"改为"进行中"

**Flyme 胶囊优化**：
- 使用 RemoteViews 自定义布局，修复通知中心展开空白问题
- 新增胶囊图标资源：课程/取件码/日程区分显示

---

### v1.1.2

**新增功能**：
- AI服务提供商快速选择：支持DeepSeek、OpenAI、Gemini、自定义
- 模型名称下拉选择器（根据提供商自动更新可选模型）
- 作息表编辑器优化：可点击修改课间休息时间、开始时间

**UI/UX 优化**：
- AI配置页全面采用Material 3设计规范
- 作息表编辑器样式优化，层次更清晰

---

### v1.1.1

**新增功能**：
- 取件码过期预警功能（PickupExpiryReceiver）
- 侧边栏导航系统（SettingsSidebar + PushSlideLayout）
- 通用 Toast 组件（UniversalToast）
- 滚轮选择器系列组件（WheelPicker）
- 设置页面模块化重构

**架构改进**：
- 设置页面拆分为独立的子页面（settings/ 目录）
- 新增 HomeScreen 作为顶层容器
- 新增 SettingsDetailScreen 统一管理设置详情页
- UI 尺寸缩放支持（uiSize 参数）

---

*文档版本：v1.4.0*
*最后更新：2026年2月5日*
*适用于 Will do v1.4.0+*
