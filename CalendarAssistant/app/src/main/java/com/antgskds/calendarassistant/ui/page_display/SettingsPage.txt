package com.antgskds.calendarassistant.ui.page_display

import android.widget.Toast
import androidx.compose.foundation.clickable
import androidx.compose.foundation.layout.*
import androidx.compose.foundation.rememberScrollState
import androidx.compose.foundation.verticalScroll
import androidx.compose.material.icons.Icons
import androidx.compose.material.icons.filled.*
import androidx.compose.material3.*
import androidx.compose.runtime.*
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.graphics.Color
import androidx.compose.ui.platform.LocalContext
import androidx.compose.ui.text.font.FontWeight
import androidx.compose.ui.unit.dp
import com.antgskds.calendarassistant.data.model.MySettings
import com.antgskds.calendarassistant.ui.components.ExpandableSettingsGroup
import com.antgskds.calendarassistant.ui.components.WheelDatePickerDialog
import com.antgskds.calendarassistant.ui.components.WheelPicker
import com.antgskds.calendarassistant.ui.viewmodel.SettingsViewModel
import kotlinx.coroutines.launch
import java.time.LocalDate
import java.time.temporal.ChronoUnit
// ✅ 修复导入：只保留 Receiver
import com.antgskds.calendarassistant.service.receiver.DailySummaryReceiver

// --- 主入口 ---
@OptIn(ExperimentalMaterial3Api::class)
@Composable
fun SettingsPage(
    viewModel: SettingsViewModel,
    onManageCourses: () -> Unit,
    onEditTimeTable: () -> Unit,
    onBack: () -> Unit
) {
    val settings by viewModel.settings.collectAsState()

    // UI 折叠状态 (Local State)
    var expandedSchedule by remember { mutableStateOf(false) }
    var expandedAI by remember { mutableStateOf(false) }
    var expandedPrefs by remember { mutableStateOf(false) }

    Scaffold(
        topBar = {
            CenterAlignedTopAppBar(
                title = { Text("设置") },
                navigationIcon = {
                    IconButton(onClick = onBack) {
                        Icon(Icons.Default.ArrowBack, contentDescription = "Back")
                    }
                }
            )
        }
    ) { innerPadding ->
        Column(
            modifier = Modifier
                .padding(innerPadding)
                .fillMaxSize()
                .verticalScroll(rememberScrollState())
                .padding(horizontal = 16.dp)
        ) {
            // 1. AI Settings
            ModelSettingsGroup(
                expanded = expandedAI,
                onExpandedChange = { expandedAI = it },
                settings = settings,
                onUpdate = { key, name, url -> viewModel.updateAiSettings(key, name, url) }
            )

            // 2. Schedule Settings
            ScheduleSettingsGroup(
                expanded = expandedSchedule,
                onExpandedChange = { expandedSchedule = it },
                settings = settings,
                onUpdateStartDate = { viewModel.updateSemesterStartDate(it) },
                onUpdateTotalWeeks = { viewModel.updateTotalWeeks(it) },
                onManageCourses = onManageCourses,
                onEditTimeTable = onEditTimeTable,
                onExportCourses = { viewModel.exportData { /* TODO */ } },
                onImportCourses = { /* TODO */ }
            )

            // 3. Preferences
            PreferenceSettingsGroup(
                expanded = expandedPrefs,
                onExpandedChange = { expandedPrefs = it },
                settings = settings,
                onUpdate = { tmr, summary, live ->
                    viewModel.updatePreference(tmr, summary, live)
                }
            )

            Spacer(Modifier.height(32.dp))
        }
    }
}

// --- 分组实现 (从旧代码 1:1 移植) ---

@Composable
fun ScheduleSettingsGroup(
    expanded: Boolean,
    onExpandedChange: (Boolean) -> Unit,
    settings: MySettings,
    onUpdateStartDate: (String) -> Unit,
    onUpdateTotalWeeks: (Int) -> Unit,
    onManageCourses: () -> Unit,
    onEditTimeTable: () -> Unit,
    onExportCourses: () -> Unit,
    onImportCourses: () -> Unit
) {
    val semesterStartDate = try {
        if(settings.semesterStartDate.isNotBlank()) LocalDate.parse(settings.semesterStartDate) else null
    } catch(e: Exception) { null }
    val totalWeeks = settings.totalWeeks

    ExpandableSettingsGroup(
        title = "课表设置",
        icon = Icons.Default.TableChart,
        expanded = expanded,
        onExpandedChange = onExpandedChange
    ) {
        val currentWeek = if (semesterStartDate != null) {
            val daysDiff = ChronoUnit.DAYS.between(semesterStartDate, LocalDate.now())
            (daysDiff / 7).toInt() + 1
        } else { 1 }

        var showDatePicker by remember { mutableStateOf(false) }
        var showWeekPicker by remember { mutableStateOf(false) }
        var showTotalWeeksPicker by remember { mutableStateOf(false) }

        Column(verticalArrangement = Arrangement.spacedBy(16.dp)) {
            // Row 1
            Row(
                modifier = Modifier.fillMaxWidth().clickable { showDatePicker = true }.padding(vertical = 8.dp),
                horizontalArrangement = Arrangement.SpaceBetween, verticalAlignment = Alignment.CenterVertically
            ) {
                Text("第一周第一天", style = MaterialTheme.typography.bodyLarge)
                Text(text = semesterStartDate?.toString() ?: "未设置", color = MaterialTheme.colorScheme.primary)
            }

            // Row 2
            Row(
                modifier = Modifier.fillMaxWidth().clickable { showWeekPicker = true }.padding(vertical = 8.dp),
                horizontalArrangement = Arrangement.SpaceBetween, verticalAlignment = Alignment.CenterVertically
            ) {
                Text("当前周", style = MaterialTheme.typography.bodyLarge)
                Text("第 $currentWeek 周", color = MaterialTheme.colorScheme.primary)
            }

            // Row 3
            Row(
                modifier = Modifier.fillMaxWidth().clickable { showTotalWeeksPicker = true }.padding(vertical = 8.dp),
                horizontalArrangement = Arrangement.SpaceBetween, verticalAlignment = Alignment.CenterVertically
            ) {
                Text("学期总周数", style = MaterialTheme.typography.bodyLarge)
                Text("$totalWeeks 周", color = MaterialTheme.colorScheme.primary)
            }

            // Row 4
            Row(
                modifier = Modifier.fillMaxWidth().clickable { onManageCourses() }.padding(vertical = 8.dp),
                horizontalArrangement = Arrangement.SpaceBetween, verticalAlignment = Alignment.CenterVertically
            ) {
                Text("课程管理", style = MaterialTheme.typography.bodyLarge)
                Icon(Icons.Default.ChevronRight, null, tint = Color.Gray)
            }

            // Row 5
            Row(
                modifier = Modifier.fillMaxWidth().clickable { onEditTimeTable() }.padding(vertical = 8.dp),
                horizontalArrangement = Arrangement.SpaceBetween, verticalAlignment = Alignment.CenterVertically
            ) {
                Column {
                    Text("作息时间设置", style = MaterialTheme.typography.bodyLarge)
                    Text("设置每日节次时间段", style = MaterialTheme.typography.bodySmall, color = Color.Gray)
                }
                Icon(Icons.Default.AccessTime, null, tint = Color.Gray)
            }

            Spacer(Modifier.height(8.dp))
            Text("课表数据", fontWeight = FontWeight.Bold, modifier = Modifier.padding(bottom = 4.dp))
            OutlinedButton(onClick = onExportCourses, modifier = Modifier.fillMaxWidth()) {
                Icon(Icons.Default.Download, null, modifier = Modifier.size(18.dp))
                Spacer(Modifier.width(8.dp))
                Text("导出课程数据")
            }
            OutlinedButton(onClick = onImportCourses, modifier = Modifier.fillMaxWidth()) {
                Icon(Icons.Default.Upload, null, modifier = Modifier.size(18.dp))
                Spacer(Modifier.width(8.dp))
                Text("导入课程数据")
            }
        }

        if (showDatePicker) {
            WheelDatePickerDialog(semesterStartDate ?: LocalDate.now(), { showDatePicker = false }) {
                onUpdateStartDate(it.toString())
                showDatePicker = false
            }
        }

        if (showWeekPicker) {
            val weekOptions = (1..30).toList()
            var selectedWeek by remember { mutableIntStateOf(currentWeek) }
            AlertDialog(
                onDismissRequest = { showWeekPicker = false },
                title = { Text("设置当前是第几周") },
                text = {
                    WheelPicker(items = weekOptions.map { "第 $it 周" }, initialIndex = (currentWeek - 1).coerceAtLeast(0), onSelectionChanged = { selectedWeek = weekOptions[it] })
                },
                confirmButton = {
                    TextButton(onClick = {
                        val today = LocalDate.now()
                        val daysToSubtract = (selectedWeek - 1) * 7L
                        val newStartDate = today.minusDays(daysToSubtract)
                        onUpdateStartDate(newStartDate.toString())
                        showWeekPicker = false
                    }) { Text("确定") }
                },
                dismissButton = { TextButton(onClick = { showWeekPicker = false }) { Text("取消") } }
            )
        }

        if (showTotalWeeksPicker) {
            val totalOptions = (10..30).toList()
            var selectedTotal by remember { mutableIntStateOf(totalWeeks) }
            AlertDialog(
                onDismissRequest = { showTotalWeeksPicker = false },
                title = { Text("设置学期总周数") },
                text = {
                    WheelPicker(items = totalOptions.map { "$it 周" }, initialIndex = totalOptions.indexOf(totalWeeks).coerceAtLeast(0), onSelectionChanged = { selectedTotal = totalOptions[it] })
                },
                confirmButton = {
                    TextButton(onClick = {
                        onUpdateTotalWeeks(selectedTotal)
                        showTotalWeeksPicker = false
                    }) { Text("确定") }
                },
                dismissButton = { TextButton(onClick = { showTotalWeeksPicker = false }) { Text("取消") } }
            )
        }
    }
}

@OptIn(ExperimentalMaterial3Api::class)
@Composable
fun ModelSettingsGroup(
    expanded: Boolean,
    onExpandedChange: (Boolean) -> Unit,
    settings: MySettings,
    onUpdate: (String, String, String) -> Unit
) {
    ExpandableSettingsGroup(
        title = "AI 模型配置",
        icon = Icons.Default.Android,
        expanded = expanded,
        onExpandedChange = onExpandedChange
    ) {
        val currentUrl = settings.modelUrl
        val currentModel = settings.modelName

        val initialProvider = when {
            currentUrl.contains("deepseek") -> "DeepSeek"
            currentUrl.contains("openai") -> "OpenAI"
            currentUrl.contains("googleapis") -> "Gemini"
            currentUrl.isBlank() && currentModel.isBlank() -> "DeepSeek"
            else -> "自定义"
        }

        var selectedProvider by remember { mutableStateOf(initialProvider) }
        var expandedProvider by remember { mutableStateOf(false) }
        var expandedModel by remember { mutableStateOf(false) }

        var modelUrl by remember { mutableStateOf(settings.modelUrl) }
        var modelName by remember { mutableStateOf(settings.modelName) }
        var modelKey by remember { mutableStateOf(settings.modelKey) }

        // 自动更新 URL
        LaunchedEffect(selectedProvider) {
            if (selectedProvider != "自定义") {
                modelUrl = when (selectedProvider) {
                    "DeepSeek" -> "https://api.deepseek.com/chat/completions"
                    "OpenAI" -> "https://api.openai.com/v1/chat/completions"
                    "Gemini" -> "https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent"
                    else -> ""
                }
            }
        }

        Column(verticalArrangement = Arrangement.spacedBy(12.dp)) {
            // Provider Dropdown
            ExposedDropdownMenuBox(expanded = expandedProvider, onExpandedChange = { expandedProvider = !expandedProvider }) {
                OutlinedTextField(
                    value = selectedProvider, onValueChange = {}, readOnly = true,
                    label = { Text("服务提供商") }, trailingIcon = { ExposedDropdownMenuDefaults.TrailingIcon(expanded = expandedProvider) },
                    modifier = Modifier.menuAnchor().fillMaxWidth()
                )
                ExposedDropdownMenu(expanded = expandedProvider, onDismissRequest = { expandedProvider = false }) {
                    listOf("DeepSeek", "OpenAI", "Gemini", "自定义").forEach { item ->
                        DropdownMenuItem(text = { Text(item) }, onClick = { selectedProvider = item; expandedProvider = false })
                    }
                }
            }

            // Model Dropdown
            if (selectedProvider != "自定义") {
                val models = when(selectedProvider) {
                    "DeepSeek" -> listOf("deepseek-chat", "deepseek-coder", "deepseek-reasoner")
                    "OpenAI" -> listOf("gpt-4o-mini", "gpt-4o", "gpt-3.5-turbo")
                    "Gemini" -> listOf("gemini-1.5-flash", "gemini-1.5-pro")
                    else -> emptyList()
                }
                ExposedDropdownMenuBox(expanded = expandedModel, onExpandedChange = { expandedModel = !expandedModel }) {
                    OutlinedTextField(
                        value = modelName, onValueChange = {}, readOnly = true,
                        label = { Text("模型名称") }, trailingIcon = { ExposedDropdownMenuDefaults.TrailingIcon(expanded = expandedModel) },
                        modifier = Modifier.menuAnchor().fillMaxWidth()
                    )
                    ExposedDropdownMenu(expanded = expandedModel, onDismissRequest = { expandedModel = false }) {
                        models.forEach { item ->
                            DropdownMenuItem(text = { Text(item) }, onClick = {
                                modelName = item; expandedModel = false
                                if (selectedProvider == "Gemini") modelUrl = "https://generativelanguage.googleapis.com/v1beta/models/$item:generateContent"
                            })
                        }
                    }
                }
            }

            OutlinedTextField(
                value = modelKey, onValueChange = { modelKey = it },
                label = { Text("API Key") }, modifier = Modifier.fillMaxWidth(), singleLine = true
            )

            if (selectedProvider == "自定义") {
                OutlinedTextField(value = modelUrl, onValueChange = { modelUrl = it }, label = { Text("API URL") }, modifier = Modifier.fillMaxWidth(), singleLine = true)
                OutlinedTextField(value = modelName, onValueChange = { modelName = it }, label = { Text("Model Name") }, modifier = Modifier.fillMaxWidth(), singleLine = true)
            }

            Button(onClick = { onUpdate(modelKey.trim(), modelName.trim(), modelUrl.trim()) }, modifier = Modifier.fillMaxWidth()) {
                Text("保存配置")
            }
        }
    }
}

@Composable
fun PreferenceSettingsGroup(
    expanded: Boolean,
    onExpandedChange: (Boolean) -> Unit,
    settings: MySettings,
    onUpdate: (Boolean?, Boolean?, Boolean?) -> Unit
) {
    val context = LocalContext.current
    var showTomorrow by remember(settings) { mutableStateOf(settings.showTomorrowEvents) }
    var dailySummary by remember(settings) { mutableStateOf(settings.isDailySummaryEnabled) }
    var liveCapsule by remember(settings) { mutableStateOf(settings.isLiveCapsuleEnabled) }
    var delayMs by remember(settings) { mutableLongStateOf(settings.screenshotDelayMs) }

    ExpandableSettingsGroup(
        title = "偏好设置",
        icon = Icons.Default.Tune,
        expanded = expanded,
        onExpandedChange = onExpandedChange
    ) {
        Column(verticalArrangement = Arrangement.spacedBy(12.dp)) {
            // Show Tomorrow
            Row(Modifier.fillMaxWidth(), horizontalArrangement = Arrangement.SpaceBetween, verticalAlignment = Alignment.CenterVertically) {
                Column(Modifier.weight(1f)) { Text("显示明日日程"); Text("列表底部预览", style = MaterialTheme.typography.bodySmall, color = Color.Gray) }
                Switch(checked = showTomorrow, onCheckedChange = { showTomorrow = it; onUpdate(it, null, null) })
            }
            // Screenshot Delay
            Column(Modifier.fillMaxWidth()) {
                Text("截图识别延迟: ${delayMs}ms")
                Slider(
                    value = delayMs.toFloat(), onValueChange = { delayMs = it.toLong() },
                    onValueChangeFinished = { /* TODO: Update Delay in ViewModel */ },
                    valueRange = 200f..2000f, steps = 17
                )
            }
            // Live Capsule
            Row(Modifier.fillMaxWidth(), horizontalArrangement = Arrangement.SpaceBetween, verticalAlignment = Alignment.CenterVertically) {
                Column(Modifier.weight(1f)) { Text("实况胶囊通知 (Beta)"); Text("需开启无障碍权限", style = MaterialTheme.typography.bodySmall, color = MaterialTheme.colorScheme.error) }
                Switch(checked = liveCapsule, onCheckedChange = {
                    liveCapsule = it; onUpdate(null, null, it)
                    if (it) Toast.makeText(context, "请确保已开启无障碍服务", Toast.LENGTH_LONG).show()
                })
            }
            // Daily Summary
            Row(Modifier.fillMaxWidth(), horizontalArrangement = Arrangement.SpaceBetween, verticalAlignment = Alignment.CenterVertically) {
                Column(Modifier.weight(1f)) { Text("每日日程提醒"); Text("早6点/晚10点推送", style = MaterialTheme.typography.bodySmall, color = Color.Gray) }
                Switch(checked = dailySummary, onCheckedChange = { isChecked ->
                    // ✅ 修复逻辑：调用合并后的 Receiver
                    dailySummary = isChecked
                    onUpdate(null, isChecked, null)
                    if (isChecked) {
                        DailySummaryReceiver.schedule(context)
                    }
                    // 注意：不需要 else cancel，因为 Receiver 内部会检查开关状态。
                })
            }
        }
    }
}