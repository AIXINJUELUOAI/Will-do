package com.antgskds.calendarassistant.core.util

import android.app.Activity
import android.content.Context
import android.content.Intent
import android.provider.AlarmClock
import android.widget.Toast
import java.time.LocalDate
import java.time.LocalDateTime
import java.util.Calendar

object AlarmUtils {
    // æ³¨æ„ï¼šè¿™é‡Œå‚æ•°åæˆ‘å»ºè®®æ”¹æˆ contextï¼Œä½†å…¶å®æˆ‘ä»¬éœ€è¦å®ƒæ˜¯ Activity
    fun createSystemAlarm(context: Context, title: String, timeStr: String, date: LocalDate) {
        try {
            val parts = timeStr.split(":")
            val hour = parts.getOrElse(0) { "09" }.toInt()
            val minute = parts.getOrElse(1) { "00" }.toInt()

            // 1. æ—¶é—´æ£€æŸ¥ï¼ˆä¿ç•™ï¼‰
            val targetDateTime = date.atTime(hour, minute)
            if (targetDateTime.isBefore(LocalDateTime.now())) {
                return
            }

            // 2. Intent é…ç½®
            val intent = Intent(AlarmClock.ACTION_SET_ALARM).apply {
                putExtra(AlarmClock.EXTRA_MESSAGE, title)
                putExtra(AlarmClock.EXTRA_HOUR, hour)
                putExtra(AlarmClock.EXTRA_MINUTES, minute)
                putExtra(AlarmClock.EXTRA_SKIP_UI, true)
                putExtra(AlarmClock.EXTRA_VIBRATE, true)

                if (date != LocalDate.now()) {
                    val dayOfWeek = date.dayOfWeek.value
                    val calendarDay = when (dayOfWeek) {
                        7 -> Calendar.SUNDAY
                        else -> dayOfWeek + 1
                    }
                    putExtra(AlarmClock.EXTRA_DAYS, arrayListOf(calendarDay))
                }

                // ğŸ”¥ã€å…³é”®ä¿®æ”¹ã€‘ç§»é™¤ FLAG_ACTIVITY_NEW_TASK
                // å› ä¸ºæˆ‘ä»¬å°†åœ¨ Activity Context ä¸‹è°ƒç”¨å®ƒ
                // flags = Intent.FLAG_ACTIVITY_NEW_TASK (ä¸è¦è¿™è¡Œï¼)
            }

            // 3. å¯åŠ¨å¹¶æ¶ˆé™¤åŠ¨ç”»
            context.startActivity(intent)

            // ğŸ”¥ã€å…³é”®ä¿®æ”¹ã€‘å¦‚æœæ˜¯ Activityï¼Œæ‰‹åŠ¨æ¶ˆé™¤åˆ‡æ¢åŠ¨ç”»
            if (context is Activity) {
                context.overridePendingTransition(0, 0)
            }

        } catch (e: Exception) {
            e.printStackTrace()
            // Toast.makeText(context, "æ— æ³•è®¾ç½®é—¹é’Ÿ", Toast.LENGTH_SHORT).show()
        }
    }
}
